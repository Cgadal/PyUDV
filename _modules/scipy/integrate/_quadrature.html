
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scipy.integrate._quadrature &#8212; pyudv  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pydata-custom.css?v=2e59d9c9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script src="../../../_static/documentation_options.js?v=7f41d439"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/scipy/integrate/_quadrature';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">pyudv</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../index.html">
                        Home page
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../_autosummary/pyudv.html">
                        API reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/cgadal-pythonpackages/pyudv" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../index.html">
                        Home page
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../_autosummary/pyudv.html">
                        API reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/cgadal-pythonpackages/pyudv" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">scipy.integr...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for scipy.integrate._quadrature</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">roots_legendre</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gammaln</span><span class="p">,</span> <span class="n">logsumexp</span>
<span class="kn">from</span> <span class="nn">scipy._lib._util</span> <span class="kn">import</span> <span class="n">_rng_spawn</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fixed_quad&#39;</span><span class="p">,</span> <span class="s1">&#39;quadrature&#39;</span><span class="p">,</span> <span class="s1">&#39;romberg&#39;</span><span class="p">,</span> <span class="s1">&#39;romb&#39;</span><span class="p">,</span>
           <span class="s1">&#39;trapezoid&#39;</span><span class="p">,</span> <span class="s1">&#39;trapz&#39;</span><span class="p">,</span> <span class="s1">&#39;simps&#39;</span><span class="p">,</span> <span class="s1">&#39;simpson&#39;</span><span class="p">,</span>
           <span class="s1">&#39;cumulative_trapezoid&#39;</span><span class="p">,</span> <span class="s1">&#39;cumtrapz&#39;</span><span class="p">,</span> <span class="s1">&#39;newton_cotes&#39;</span><span class="p">,</span>
           <span class="s1">&#39;qmc_quad&#39;</span><span class="p">,</span> <span class="s1">&#39;AccuracyWarning&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate along the given axis using the composite trapezoidal rule.</span>

<span class="sd">    If `x` is provided, the integration happens in sequence along its</span>
<span class="sd">    elements - they are not sorted.</span>

<span class="sd">    Integrate `y` (`x`) along each 1d slice on the given axis, compute</span>
<span class="sd">    :math:`\int y(x) dx`.</span>
<span class="sd">    When `x` is specified, this integrates along the parametric curve,</span>
<span class="sd">    computing :math:`\int_t y(t) dt =</span>
<span class="sd">    \int_t y(t) \left.\frac{dx}{dt}\right|_{x=x(t)} dt`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : array_like</span>
<span class="sd">        Input array to integrate.</span>
<span class="sd">    x : array_like, optional</span>
<span class="sd">        The sample points corresponding to the `y` values. If `x` is None,</span>
<span class="sd">        the sample points are assumed to be evenly spaced `dx` apart. The</span>
<span class="sd">        default is None.</span>
<span class="sd">    dx : scalar, optional</span>
<span class="sd">        The spacing between sample points when `x` is None. The default is 1.</span>
<span class="sd">    axis : int, optional</span>
<span class="sd">        The axis along which to integrate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trapezoid : float or ndarray</span>
<span class="sd">        Definite integral of `y` = n-dimensional array as approximated along</span>
<span class="sd">        a single axis by the trapezoidal rule. If `y` is a 1-dimensional array,</span>
<span class="sd">        then the result is a float. If `n` is greater than 1, then the result</span>
<span class="sd">        is an `n`-1 dimensional array.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    cumulative_trapezoid, simpson, romb</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Image [2]_ illustrates trapezoidal rule -- y-axis locations of points</span>
<span class="sd">    will be taken from `y` array, by default x-axis distances between</span>
<span class="sd">    points will be 1.0, alternatively they can be provided with `x` array</span>
<span class="sd">    or with `dx` scalar.  Return value will be equal to combined area under</span>
<span class="sd">    the red lines.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Wikipedia page: https://en.wikipedia.org/wiki/Trapezoidal_rule</span>

<span class="sd">    .. [2] Illustration image:</span>
<span class="sd">           https://en.wikipedia.org/wiki/File:Composite_trapezoidal_rule_illustration.png</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Use the trapezoidal rule on evenly spaced points:</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; integrate.trapezoid([1, 2, 3])</span>
<span class="sd">    4.0</span>

<span class="sd">    The spacing between sample points can be selected by either the</span>
<span class="sd">    ``x`` or ``dx`` arguments:</span>

<span class="sd">    &gt;&gt;&gt; integrate.trapezoid([1, 2, 3], x=[4, 6, 8])</span>
<span class="sd">    8.0</span>
<span class="sd">    &gt;&gt;&gt; integrate.trapezoid([1, 2, 3], dx=2)</span>
<span class="sd">    8.0</span>

<span class="sd">    Using a decreasing ``x`` corresponds to integrating in reverse:</span>

<span class="sd">    &gt;&gt;&gt; integrate.trapezoid([1, 2, 3], x=[8, 6, 4])</span>
<span class="sd">    -8.0</span>

<span class="sd">    More generally ``x`` is used to integrate along a parametric curve. We can</span>
<span class="sd">    estimate the integral :math:`\int_0^1 x^2 = 1/3` using:</span>

<span class="sd">    &gt;&gt;&gt; x = np.linspace(0, 1, num=50)</span>
<span class="sd">    &gt;&gt;&gt; y = x**2</span>
<span class="sd">    &gt;&gt;&gt; integrate.trapezoid(y, x)</span>
<span class="sd">    0.33340274885464394</span>

<span class="sd">    Or estimate the area of a circle, noting we repeat the sample which closes</span>
<span class="sd">    the curve:</span>

<span class="sd">    &gt;&gt;&gt; theta = np.linspace(0, 2 * np.pi, num=1000, endpoint=True)</span>
<span class="sd">    &gt;&gt;&gt; integrate.trapezoid(np.cos(theta), x=np.sin(theta))</span>
<span class="sd">    3.141571941375841</span>

<span class="sd">    ``trapezoid`` can be applied along a specified axis to do multiple</span>
<span class="sd">    computations in one call:</span>

<span class="sd">    &gt;&gt;&gt; a = np.arange(6).reshape(2, 3)</span>
<span class="sd">    &gt;&gt;&gt; a</span>
<span class="sd">    array([[0, 1, 2],</span>
<span class="sd">           [3, 4, 5]])</span>
<span class="sd">    &gt;&gt;&gt; integrate.trapezoid(a, axis=0)</span>
<span class="sd">    array([1.5, 2.5, 3.5])</span>
<span class="sd">    &gt;&gt;&gt; integrate.trapezoid(a, axis=1)</span>
<span class="sd">    array([2.,  8.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Future-proofing, in case NumPy moves from trapz to trapezoid for the same</span>
    <span class="c1"># reasons as SciPy</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;trapezoid&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>


<span class="c1"># Note: alias kept for backwards compatibility. Rename was done</span>
<span class="c1"># because trapz is a slur in colloquial English (see gh-12924).</span>
<span class="k">def</span> <span class="nf">trapz</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An alias of `trapezoid`.</span>

<span class="sd">    `trapz` is kept for backwards compatibility. For new code, prefer</span>
<span class="sd">    `trapezoid` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AccuracyWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># workaround for mypy function attributes see:</span>
    <span class="c1"># https://github.com/python/mypy/issues/2087#issuecomment-462726600</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Protocol</span>

    <span class="k">class</span> <span class="nc">CacheAttributes</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
        <span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">CacheAttributes</span> <span class="o">=</span> <span class="n">Callable</span>


<span class="k">def</span> <span class="nf">cache_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CacheAttributes</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">CacheAttributes</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>


<span class="nd">@cache_decorator</span>
<span class="k">def</span> <span class="nf">_cached_roots_legendre</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cache roots_legendre results to speed up calls of the fixed_quad</span>
<span class="sd">    function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_cached_roots_legendre</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_cached_roots_legendre</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

    <span class="n">_cached_roots_legendre</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">roots_legendre</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_cached_roots_legendre</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>


<span class="n">_cached_roots_legendre</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">fixed_quad</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a definite integral using fixed-order Gaussian quadrature.</span>

<span class="sd">    Integrate `func` from `a` to `b` using Gaussian quadrature of</span>
<span class="sd">    order `n`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : callable</span>
<span class="sd">        A Python function or method to integrate (must accept vector inputs).</span>
<span class="sd">        If integrating a vector-valued function, the returned array must have</span>
<span class="sd">        shape ``(..., len(x))``.</span>
<span class="sd">    a : float</span>
<span class="sd">        Lower limit of integration.</span>
<span class="sd">    b : float</span>
<span class="sd">        Upper limit of integration.</span>
<span class="sd">    args : tuple, optional</span>
<span class="sd">        Extra arguments to pass to function, if any.</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        Order of quadrature integration. Default is 5.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    val : float</span>
<span class="sd">        Gaussian quadrature approximation to the integral</span>
<span class="sd">    none : None</span>
<span class="sd">        Statically returned value of None</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    quad : adaptive quadrature using QUADPACK</span>
<span class="sd">    dblquad : double integrals</span>
<span class="sd">    tplquad : triple integrals</span>
<span class="sd">    romberg : adaptive Romberg quadrature</span>
<span class="sd">    quadrature : adaptive Gaussian quadrature</span>
<span class="sd">    romb : integrators for sampled data</span>
<span class="sd">    simpson : integrators for sampled data</span>
<span class="sd">    cumulative_trapezoid : cumulative integration for sampled data</span>
<span class="sd">    ode : ODE integrator</span>
<span class="sd">    odeint : ODE integrator</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; f = lambda x: x**8</span>
<span class="sd">    &gt;&gt;&gt; integrate.fixed_quad(f, 0.0, 1.0, n=4)</span>
<span class="sd">    (0.1110884353741496, None)</span>
<span class="sd">    &gt;&gt;&gt; integrate.fixed_quad(f, 0.0, 1.0, n=5)</span>
<span class="sd">    (0.11111111111111102, None)</span>
<span class="sd">    &gt;&gt;&gt; print(1/9.0)  # analytical result</span>
<span class="sd">    0.1111111111111111</span>

<span class="sd">    &gt;&gt;&gt; integrate.fixed_quad(np.cos, 0.0, np.pi/2, n=4)</span>
<span class="sd">    (0.9999999771971152, None)</span>
<span class="sd">    &gt;&gt;&gt; integrate.fixed_quad(np.cos, 0.0, np.pi/2, n=5)</span>
<span class="sd">    (1.000000000039565, None)</span>
<span class="sd">    &gt;&gt;&gt; np.sin(np.pi/2)-np.sin(0)  # analytical result</span>
<span class="sd">    1.0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">_cached_roots_legendre</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gaussian quadrature is only available for &quot;</span>
                         <span class="s2">&quot;finite limits.&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">a</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">vectorize1</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">vec_func</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Vectorize the call to a function.</span>

<span class="sd">    This is an internal utility function used by `romberg` and</span>
<span class="sd">    `quadrature` to create a vectorized version of a function.</span>

<span class="sd">    If `vec_func` is True, the function `func` is assumed to take vector</span>
<span class="sd">    arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : callable</span>
<span class="sd">        User defined function.</span>
<span class="sd">    args : tuple, optional</span>
<span class="sd">        Extra arguments for the function.</span>
<span class="sd">    vec_func : bool, optional</span>
<span class="sd">        True if the function func takes vector arguments.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vfunc : callable</span>
<span class="sd">        A function that will take a vector argument and return the</span>
<span class="sd">        result.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vec_func</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">vfunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">vfunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># call with first point to get output type</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">y0</span><span class="p">))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>
    <span class="k">return</span> <span class="n">vfunc</span>


<span class="k">def</span> <span class="nf">quadrature</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.49e-8</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.49e-8</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
               <span class="n">vec_func</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">miniter</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a definite integral using fixed-tolerance Gaussian quadrature.</span>

<span class="sd">    Integrate `func` from `a` to `b` using Gaussian quadrature</span>
<span class="sd">    with absolute tolerance `tol`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : function</span>
<span class="sd">        A Python function or method to integrate.</span>
<span class="sd">    a : float</span>
<span class="sd">        Lower limit of integration.</span>
<span class="sd">    b : float</span>
<span class="sd">        Upper limit of integration.</span>
<span class="sd">    args : tuple, optional</span>
<span class="sd">        Extra arguments to pass to function.</span>
<span class="sd">    tol, rtol : float, optional</span>
<span class="sd">        Iteration stops when error between last two iterates is less than</span>
<span class="sd">        `tol` OR the relative change is less than `rtol`.</span>
<span class="sd">    maxiter : int, optional</span>
<span class="sd">        Maximum order of Gaussian quadrature.</span>
<span class="sd">    vec_func : bool, optional</span>
<span class="sd">        True or False if func handles arrays as arguments (is</span>
<span class="sd">        a &quot;vector&quot; function). Default is True.</span>
<span class="sd">    miniter : int, optional</span>
<span class="sd">        Minimum order of Gaussian quadrature.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    val : float</span>
<span class="sd">        Gaussian quadrature approximation (within tolerance) to integral.</span>
<span class="sd">    err : float</span>
<span class="sd">        Difference between last two estimates of the integral.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    romberg : adaptive Romberg quadrature</span>
<span class="sd">    fixed_quad : fixed-order Gaussian quadrature</span>
<span class="sd">    quad : adaptive quadrature using QUADPACK</span>
<span class="sd">    dblquad : double integrals</span>
<span class="sd">    tplquad : triple integrals</span>
<span class="sd">    romb : integrator for sampled data</span>
<span class="sd">    simpson : integrator for sampled data</span>
<span class="sd">    cumulative_trapezoid : cumulative integration for sampled data</span>
<span class="sd">    ode : ODE integrator</span>
<span class="sd">    odeint : ODE integrator</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; f = lambda x: x**8</span>
<span class="sd">    &gt;&gt;&gt; integrate.quadrature(f, 0.0, 1.0)</span>
<span class="sd">    (0.11111111111111106, 4.163336342344337e-17)</span>
<span class="sd">    &gt;&gt;&gt; print(1/9.0)  # analytical result</span>
<span class="sd">    0.1111111111111111</span>

<span class="sd">    &gt;&gt;&gt; integrate.quadrature(np.cos, 0.0, np.pi/2)</span>
<span class="sd">    (0.9999999999999536, 3.9611425250996035e-11)</span>
<span class="sd">    &gt;&gt;&gt; np.sin(np.pi/2)-np.sin(0)  # analytical result</span>
<span class="sd">    1.0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>
    <span class="n">vfunc</span> <span class="o">=</span> <span class="n">vectorize1</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">vec_func</span><span class="o">=</span><span class="n">vec_func</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">miniter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">miniter</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">newval</span> <span class="o">=</span> <span class="n">fixed_quad</span><span class="p">(</span><span class="n">vfunc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(),</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">newval</span><span class="o">-</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">newval</span>

        <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">rtol</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;maxiter (</span><span class="si">%d</span><span class="s2">) exceeded. Latest difference = </span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
            <span class="n">AccuracyWarning</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span>


<span class="k">def</span> <span class="nf">tupleset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>


<span class="c1"># Note: alias kept for backwards compatibility. Rename was done</span>
<span class="c1"># because cumtrapz is a slur in colloquial English (see gh-12924).</span>
<span class="k">def</span> <span class="nf">cumtrapz</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An alias of `cumulative_trapezoid`.</span>

<span class="sd">    `cumtrapz` is kept for backwards compatibility. For new code, prefer</span>
<span class="sd">    `cumulative_trapezoid` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>


<div class="viewcode-block" id="cumulative_trapezoid">
<a class="viewcode-back" href="../../../_autosummary/pyudv.attenuation.direct_models.cumulative_trapezoid.html#pyudv.attenuation.cumulative_trapezoid">[docs]</a>
<span class="k">def</span> <span class="nf">cumulative_trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cumulatively integrate y(x) using the composite trapezoidal rule.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : array_like</span>
<span class="sd">        Values to integrate.</span>
<span class="sd">    x : array_like, optional</span>
<span class="sd">        The coordinate to integrate along. If None (default), use spacing `dx`</span>
<span class="sd">        between consecutive elements in `y`.</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        Spacing between elements of `y`. Only used if `x` is None.</span>
<span class="sd">    axis : int, optional</span>
<span class="sd">        Specifies the axis to cumulate. Default is -1 (last axis).</span>
<span class="sd">    initial : scalar, optional</span>
<span class="sd">        If given, insert this value at the beginning of the returned result.</span>
<span class="sd">        Typically this value should be 0. Default is None, which means no</span>
<span class="sd">        value at ``x[0]`` is returned and `res` has one element less than `y`</span>
<span class="sd">        along the axis of integration.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res : ndarray</span>
<span class="sd">        The result of cumulative integration of `y` along `axis`.</span>
<span class="sd">        If `initial` is None, the shape is such that the axis of integration</span>
<span class="sd">        has one less value than `y`. If `initial` is given, the shape is equal</span>
<span class="sd">        to that of `y`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    numpy.cumsum, numpy.cumprod</span>
<span class="sd">    quad : adaptive quadrature using QUADPACK</span>
<span class="sd">    romberg : adaptive Romberg quadrature</span>
<span class="sd">    quadrature : adaptive Gaussian quadrature</span>
<span class="sd">    fixed_quad : fixed-order Gaussian quadrature</span>
<span class="sd">    dblquad : double integrals</span>
<span class="sd">    tplquad : triple integrals</span>
<span class="sd">    romb : integrators for sampled data</span>
<span class="sd">    ode : ODE integrators</span>
<span class="sd">    odeint : ODE integrators</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>

<span class="sd">    &gt;&gt;&gt; x = np.linspace(-2, 2, num=20)</span>
<span class="sd">    &gt;&gt;&gt; y = x</span>
<span class="sd">    &gt;&gt;&gt; y_int = integrate.cumulative_trapezoid(y, x, initial=0)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(x, y_int, &#39;ro&#39;, x, y[0] + 0.5 * x**2, &#39;b-&#39;)</span>
<span class="sd">    &gt;&gt;&gt; plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># reshape to correct shape</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If given, shape of x must be 1-D or the &quot;</span>
                             <span class="s2">&quot;same as y.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If given, length of x along axis must be the &quot;</span>
                             <span class="s2">&quot;same as y.&quot;</span><span class="p">)</span>

    <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">((</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span><span class="o">*</span><span class="n">nd</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">slice2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">((</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span><span class="o">*</span><span class="n">nd</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">initial</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`initial` parameter should be a scalar.&quot;</span><span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">res</span><span class="p">],</span>
                             <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>



<span class="k">def</span> <span class="nf">_basic_simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">slice_all</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span><span class="o">*</span><span class="n">nd</span>
    <span class="n">slice0</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
    <span class="n">slice1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
    <span class="n">slice2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">stop</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Even-spaced Simpson&#39;s rule.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">*=</span> <span class="n">dx</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Account for possibly different spacings.</span>
        <span class="c1">#    Simpson&#39;s rule changes a bit.</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">sl0</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
        <span class="n">sl1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">sl0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">sl1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">hsum</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">h1</span>
        <span class="n">hprod</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">h1</span>
        <span class="n">h0divh1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h0</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">h1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">hsum</span><span class="o">/</span><span class="mf">6.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice0</span><span class="p">]</span> <span class="o">*</span>
                          <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">h0divh1</span><span class="p">,</span>
                                                <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">h0divh1</span><span class="p">),</span>
                                                <span class="n">where</span><span class="o">=</span><span class="n">h0divh1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span>
                          <span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">hsum</span> <span class="o">*</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">hsum</span><span class="p">,</span> <span class="n">hprod</span><span class="p">,</span>
                                                      <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hsum</span><span class="p">),</span>
                                                      <span class="n">where</span><span class="o">=</span><span class="n">hprod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span>
                          <span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">h0divh1</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># Note: alias kept for backwards compatibility. simps was renamed to simpson</span>
<span class="c1"># because the former is a slur in colloquial English (see gh-12924).</span>
<span class="k">def</span> <span class="nf">simps</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">even</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An alias of `simpson`.</span>

<span class="sd">    `simps` is kept for backwards compatibility. For new code, prefer</span>
<span class="sd">    `simpson` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">even</span><span class="o">=</span><span class="n">even</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">even</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate y(x) using samples along the given axis and the composite</span>
<span class="sd">    Simpson&#39;s rule. If x is None, spacing of dx is assumed.</span>

<span class="sd">    If there are an even number of samples, N, then there are an odd</span>
<span class="sd">    number of intervals (N-1), but Simpson&#39;s rule requires an even number</span>
<span class="sd">    of intervals. The parameter &#39;even&#39; controls how this is handled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : array_like</span>
<span class="sd">        Array to be integrated.</span>
<span class="sd">    x : array_like, optional</span>
<span class="sd">        If given, the points at which `y` is sampled.</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        Spacing of integration points along axis of `x`. Only used when</span>
<span class="sd">        `x` is None. Default is 1.</span>
<span class="sd">    axis : int, optional</span>
<span class="sd">        Axis along which to integrate. Default is the last axis.</span>
<span class="sd">    even : {None, &#39;simpson&#39;, &#39;avg&#39;, &#39;first&#39;, &#39;last&#39;}, optional</span>
<span class="sd">        &#39;avg&#39; : Average two results:</span>
<span class="sd">            1) use the first N-2 intervals with</span>
<span class="sd">               a trapezoidal rule on the last interval and</span>
<span class="sd">            2) use the last</span>
<span class="sd">               N-2 intervals with a trapezoidal rule on the first interval.</span>

<span class="sd">        &#39;first&#39; : Use Simpson&#39;s rule for the first N-2 intervals with</span>
<span class="sd">                a trapezoidal rule on the last interval.</span>

<span class="sd">        &#39;last&#39; : Use Simpson&#39;s rule for the last N-2 intervals with a</span>
<span class="sd">               trapezoidal rule on the first interval.</span>

<span class="sd">        None : equivalent to &#39;simpson&#39; (default)</span>

<span class="sd">        &#39;simpson&#39; : Use Simpson&#39;s rule for the first N-2 intervals with the</span>
<span class="sd">                  addition of a 3-point parabolic segment for the last</span>
<span class="sd">                  interval using equations outlined by Cartwright [1]_.</span>
<span class="sd">                  If the axis to be integrated over only has two points then</span>
<span class="sd">                  the integration falls back to a trapezoidal integration.</span>

<span class="sd">                  .. versionadded:: 1.11.0</span>

<span class="sd">        .. versionchanged:: 1.11.0</span>
<span class="sd">            The newly added &#39;simpson&#39; option is now the default as it is more</span>
<span class="sd">            accurate in most situations.</span>

<span class="sd">        .. deprecated:: 1.11.0</span>
<span class="sd">            Parameter `even` is deprecated and will be removed in SciPy</span>
<span class="sd">            1.13.0. After this time the behaviour for an even number of</span>
<span class="sd">            points will follow that of `even=&#39;simpson&#39;`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The estimated integral computed with the composite Simpson&#39;s rule.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    quad : adaptive quadrature using QUADPACK</span>
<span class="sd">    romberg : adaptive Romberg quadrature</span>
<span class="sd">    quadrature : adaptive Gaussian quadrature</span>
<span class="sd">    fixed_quad : fixed-order Gaussian quadrature</span>
<span class="sd">    dblquad : double integrals</span>
<span class="sd">    tplquad : triple integrals</span>
<span class="sd">    romb : integrators for sampled data</span>
<span class="sd">    cumulative_trapezoid : cumulative integration for sampled data</span>
<span class="sd">    ode : ODE integrators</span>
<span class="sd">    odeint : ODE integrators</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    For an odd number of samples that are equally spaced the result is</span>
<span class="sd">    exact if the function is a polynomial of order 3 or less. If</span>
<span class="sd">    the samples are not equally spaced, then the result is exact only</span>
<span class="sd">    if the function is a polynomial of order 2 or less.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Cartwright, Kenneth V. Simpson&#39;s Rule Cumulative Integration with</span>
<span class="sd">           MS Excel and Irregularly-spaced Data. Journal of Mathematical</span>
<span class="sd">           Sciences and Mathematics Education. 12 (2): 1-9</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(0, 10)</span>
<span class="sd">    &gt;&gt;&gt; y = np.arange(0, 10)</span>

<span class="sd">    &gt;&gt;&gt; integrate.simpson(y, x)</span>
<span class="sd">    40.5</span>

<span class="sd">    &gt;&gt;&gt; y = np.power(x, 3)</span>
<span class="sd">    &gt;&gt;&gt; integrate.simpson(y, x)</span>
<span class="sd">    1640.5</span>
<span class="sd">    &gt;&gt;&gt; integrate.quad(lambda x: x**3, 0, 9)[0]</span>
<span class="sd">    1640.25</span>

<span class="sd">    &gt;&gt;&gt; integrate.simpson(y, x, even=&#39;first&#39;)</span>
<span class="sd">    1644.5</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">last_dx</span> <span class="o">=</span> <span class="n">dx</span>
    <span class="n">first_dx</span> <span class="o">=</span> <span class="n">dx</span>
    <span class="n">returnshape</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shapex</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nd</span>
            <span class="n">shapex</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">saveshape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">returnshape</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shapex</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If given, shape of x must be 1-D or the &quot;</span>
                             <span class="s2">&quot;same as y.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If given, length of x along axis must be the &quot;</span>
                             <span class="s2">&quot;same as y.&quot;</span><span class="p">)</span>

    <span class="c1"># even keyword parameter is deprecated</span>
    <span class="k">if</span> <span class="n">even</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;even&#39; keyword is deprecated as of SciPy 1.11.0 and will be &quot;</span>
            <span class="s2">&quot;removed in SciPy 1.13.0&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">slice_all</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">nd</span>

        <span class="c1"># default is &#39;simpson&#39;</span>
        <span class="n">even</span> <span class="o">=</span> <span class="n">even</span> <span class="k">if</span> <span class="n">even</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;simpson&quot;</span>

        <span class="k">if</span> <span class="n">even</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;simpson&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter &#39;even&#39; must be &#39;simpson&#39;, &quot;</span>
                <span class="s2">&quot;&#39;avg&#39;, &#39;last&#39;, or &#39;first&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># need at least 3 points in integration axis to form parabolic</span>
            <span class="c1"># segment. If there are two points then any of &#39;avg&#39;, &#39;first&#39;,</span>
            <span class="c1"># &#39;last&#39; should give the same result.</span>
            <span class="n">slice1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">slice2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">slice2</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">last_dx</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">])</span>

            <span class="c1"># calculation is finished. Set `even` to None to skip other</span>
            <span class="c1"># scenarios</span>
            <span class="n">even</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">even</span> <span class="o">==</span> <span class="s1">&#39;simpson&#39;</span><span class="p">:</span>
            <span class="c1"># use Simpson&#39;s rule on first intervals</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_basic_simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

            <span class="n">slice1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">slice2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">slice3</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># grab the last two spacings from the appropriate axis</span>
                <span class="n">hm2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">hm1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
                <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">diffs</span><span class="p">[</span><span class="n">hm2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">diffs</span><span class="p">[</span><span class="n">hm1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)]</span>

            <span class="c1"># This is the correction for the last interval according to</span>
            <span class="c1"># Cartwright.</span>
            <span class="c1"># However, I used the equations given at</span>
            <span class="c1"># https://en.wikipedia.org/wiki/Simpson%27s_rule#Composite_Simpson&#39;s_rule_for_irregularly_spaced_data</span>
            <span class="c1"># A footnote on Wikipedia says:</span>
            <span class="c1"># Cartwright 2017, Equation 8. The equation in Cartwright is</span>
            <span class="c1"># calculating the first interval whereas the equations in the</span>
            <span class="c1"># Wikipedia article are adjusting for the last integral. If the</span>
            <span class="c1"># proper algebraic substitutions are made, the equation results in</span>
            <span class="c1"># the values shown.</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">den</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span>
                <span class="n">num</span><span class="p">,</span>
                <span class="n">den</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">den</span><span class="p">),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">den</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">)</span>

            <span class="n">num</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">den</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span>
                <span class="n">num</span><span class="p">,</span>
                <span class="n">den</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">den</span><span class="p">),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">den</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">)</span>

            <span class="n">num</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
            <span class="n">den</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span>
                <span class="n">num</span><span class="p">,</span>
                <span class="n">den</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">den</span><span class="p">),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">den</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">]</span> <span class="o">-</span> <span class="n">eta</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">slice3</span><span class="p">]</span>

        <span class="c1"># The following code (down to result=result+val) can be removed</span>
        <span class="c1"># once the &#39;even&#39; keyword is removed.</span>

        <span class="c1"># Compute using Simpson&#39;s rule on first intervals</span>
        <span class="k">if</span> <span class="n">even</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">]:</span>
            <span class="n">slice1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">slice2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">slice2</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">last_dx</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_basic_simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="c1"># Compute using Simpson&#39;s rule on last set of intervals</span>
        <span class="k">if</span> <span class="n">even</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">]:</span>
            <span class="n">slice1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">slice2</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">first_dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slice2</span><span class="p">)]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slice1</span><span class="p">)]</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">first_dx</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice2</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">slice1</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">_basic_simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">even</span> <span class="o">==</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">/=</span> <span class="mf">2.0</span>
            <span class="n">result</span> <span class="o">/=</span> <span class="mf">2.0</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_basic_simpson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">returnshape</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">saveshape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">romb</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Romberg integration using samples of a function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : array_like</span>
<span class="sd">        A vector of ``2**k + 1`` equally-spaced samples of a function.</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        The sample spacing. Default is 1.</span>
<span class="sd">    axis : int, optional</span>
<span class="sd">        The axis along which to integrate. Default is -1 (last axis).</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        When `y` is a single 1-D array, then if this argument is True</span>
<span class="sd">        print the table showing Richardson extrapolation from the</span>
<span class="sd">        samples. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    romb : ndarray</span>
<span class="sd">        The integrated result for `axis`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    quad : adaptive quadrature using QUADPACK</span>
<span class="sd">    romberg : adaptive Romberg quadrature</span>
<span class="sd">    quadrature : adaptive Gaussian quadrature</span>
<span class="sd">    fixed_quad : fixed-order Gaussian quadrature</span>
<span class="sd">    dblquad : double integrals</span>
<span class="sd">    tplquad : triple integrals</span>
<span class="sd">    simpson : integrators for sampled data</span>
<span class="sd">    cumulative_trapezoid : cumulative integration for sampled data</span>
<span class="sd">    ode : ODE integrators</span>
<span class="sd">    odeint : ODE integrators</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; x = np.arange(10, 14.25, 0.25)</span>
<span class="sd">    &gt;&gt;&gt; y = np.arange(3, 12)</span>

<span class="sd">    &gt;&gt;&gt; integrate.romb(y)</span>
<span class="sd">    56.0</span>

<span class="sd">    &gt;&gt;&gt; y = np.sin(np.power(x, 2.5))</span>
<span class="sd">    &gt;&gt;&gt; integrate.romb(y)</span>
<span class="sd">    -0.742561336672229</span>

<span class="sd">    &gt;&gt;&gt; integrate.romb(y, show=True)</span>
<span class="sd">    Richardson Extrapolation Table for Romberg Integration</span>
<span class="sd">    ======================================================</span>
<span class="sd">    -0.81576</span>
<span class="sd">     4.63862  6.45674</span>
<span class="sd">    -1.10581 -3.02062 -3.65245</span>
<span class="sd">    -2.57379 -3.06311 -3.06595 -3.05664</span>
<span class="sd">    -1.34093 -0.92997 -0.78776 -0.75160 -0.74256</span>
<span class="sd">    ======================================================</span>
<span class="sd">    -0.742561336672229  # may vary</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Nsamps</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">Ninterv</span> <span class="o">=</span> <span class="n">Nsamps</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">Ninterv</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">Ninterv</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of samples must be one plus a &quot;</span>
                         <span class="s2">&quot;non-negative power of 2.&quot;</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">slice_all</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">nd</span>
    <span class="n">slice0</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">slicem1</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_all</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">Ninterv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">slice0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">slicem1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">h</span>
    <span class="n">slice_R</span> <span class="o">=</span> <span class="n">slice_all</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">step</span> <span class="o">=</span> <span class="n">Ninterv</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
        <span class="n">slice_R</span> <span class="o">=</span> <span class="n">tupleset</span><span class="p">(</span><span class="n">slice_R</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
        <span class="n">R</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">slice_R</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">R</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">R</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">+</span> <span class="p">(</span><span class="n">prev</span><span class="o">-</span><span class="n">R</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">/=</span> <span class="mf">2.0</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">R</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Printing table only supported for integrals&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot; of a single data set.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">precis</span> <span class="o">=</span> <span class="n">show</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="n">precis</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">show</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">formstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%%%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">precis</span><span class="p">)</span>

            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Richardson Extrapolation Table for Romberg Integration&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">formstr</span> <span class="o">%</span> <span class="n">R</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)],</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>

<span class="c1"># Romberg quadratures for numeric integration.</span>
<span class="c1">#</span>
<span class="c1"># Written by Scott M. Ransom &lt;ransom@cfa.harvard.edu&gt;</span>
<span class="c1"># last revision: 14 Nov 98</span>
<span class="c1">#</span>
<span class="c1"># Cosmetic changes by Konrad Hinsen &lt;hinsen@cnrs-orleans.fr&gt;</span>
<span class="c1"># last revision: 1999-7-21</span>
<span class="c1">#</span>
<span class="c1"># Adapted to SciPy by Travis Oliphant &lt;oliphant.travis@ieee.org&gt;</span>
<span class="c1"># last revision: Dec 2001</span>


<span class="k">def</span> <span class="nf">_difftrap</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">numtraps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform part of the trapezoidal rule to integrate a function.</span>
<span class="sd">    Assume that we had called difftrap with all lower powers-of-2</span>
<span class="sd">    starting with 1. Calling difftrap only returns the summation</span>
<span class="sd">    of the new ordinates. It does _not_ multiply by the width</span>
<span class="sd">    of the trapezoids. This must be performed by the caller.</span>
<span class="sd">        &#39;function&#39; is the function to evaluate (must accept vector arguments).</span>
<span class="sd">        &#39;interval&#39; is a sequence with lower and upper limits</span>
<span class="sd">                   of integration.</span>
<span class="sd">        &#39;numtraps&#39; is the number of trapezoids to use (must be a</span>
<span class="sd">                   power-of-2).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">numtraps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;numtraps must be &gt; 0 in difftrap().&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numtraps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">function</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">numtosum</span> <span class="o">=</span> <span class="n">numtraps</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">numtosum</span>
        <span class="n">lox</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">lox</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numtosum</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_romberg_diff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the differences for the Romberg quadrature corrections.</span>
<span class="sd">    See Forman Acton&#39;s &quot;Real Computing Made Real,&quot; p 143.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">**</span><span class="n">k</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_printresmat</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">resmat</span><span class="p">):</span>
    <span class="c1"># Print the Romberg result matrix.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Romberg integration of&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">function</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%9s</span><span class="s1"> </span><span class="si">%9s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;Steps&#39;</span><span class="p">,</span> <span class="s1">&#39;StepSize&#39;</span><span class="p">,</span> <span class="s1">&#39;Results&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resmat</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6d</span><span class="s1"> </span><span class="si">%9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">**</span><span class="n">i</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The final result is&#39;</span><span class="p">,</span> <span class="n">resmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resmat</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function evaluations.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">romberg</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.48e-8</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.48e-8</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">divmax</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vec_func</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Romberg integration of a callable function or method.</span>

<span class="sd">    Returns the integral of `function` (a function of one variable)</span>
<span class="sd">    over the interval (`a`, `b`).</span>

<span class="sd">    If `show` is 1, the triangular array of the intermediate results</span>
<span class="sd">    will be printed. If `vec_func` is True (default is False), then</span>
<span class="sd">    `function` is assumed to support vector arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function : callable</span>
<span class="sd">        Function to be integrated.</span>
<span class="sd">    a : float</span>
<span class="sd">        Lower limit of integration.</span>
<span class="sd">    b : float</span>
<span class="sd">        Upper limit of integration.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results : float</span>
<span class="sd">        Result of the integration.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    args : tuple, optional</span>
<span class="sd">        Extra arguments to pass to function. Each element of `args` will</span>
<span class="sd">        be passed as a single argument to `func`. Default is to pass no</span>
<span class="sd">        extra arguments.</span>
<span class="sd">    tol, rtol : float, optional</span>
<span class="sd">        The desired absolute and relative tolerances. Defaults are 1.48e-8.</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        Whether to print the results. Default is False.</span>
<span class="sd">    divmax : int, optional</span>
<span class="sd">        Maximum order of extrapolation. Default is 10.</span>
<span class="sd">    vec_func : bool, optional</span>
<span class="sd">        Whether `func` handles arrays as arguments (i.e., whether it is a</span>
<span class="sd">        &quot;vector&quot; function). Default is False.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    fixed_quad : Fixed-order Gaussian quadrature.</span>
<span class="sd">    quad : Adaptive quadrature using QUADPACK.</span>
<span class="sd">    dblquad : Double integrals.</span>
<span class="sd">    tplquad : Triple integrals.</span>
<span class="sd">    romb : Integrators for sampled data.</span>
<span class="sd">    simpson : Integrators for sampled data.</span>
<span class="sd">    cumulative_trapezoid : Cumulative integration for sampled data.</span>
<span class="sd">    ode : ODE integrator.</span>
<span class="sd">    odeint : ODE integrator.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] &#39;Romberg&#39;s method&#39; https://en.wikipedia.org/wiki/Romberg%27s_method</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Integrate a gaussian from 0 to 1 and compare to the error function.</span>

<span class="sd">    &gt;&gt;&gt; from scipy import integrate</span>
<span class="sd">    &gt;&gt;&gt; from scipy.special import erf</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; gaussian = lambda x: 1/np.sqrt(np.pi) * np.exp(-x**2)</span>
<span class="sd">    &gt;&gt;&gt; result = integrate.romberg(gaussian, 0, 1, show=True)</span>
<span class="sd">    Romberg integration of &lt;function vfunc at ...&gt; from [0, 1]</span>

<span class="sd">    ::</span>

<span class="sd">       Steps  StepSize  Results</span>
<span class="sd">           1  1.000000  0.385872</span>
<span class="sd">           2  0.500000  0.412631  0.421551</span>
<span class="sd">           4  0.250000  0.419184  0.421368  0.421356</span>
<span class="sd">           8  0.125000  0.420810  0.421352  0.421350  0.421350</span>
<span class="sd">          16  0.062500  0.421215  0.421350  0.421350  0.421350  0.421350</span>
<span class="sd">          32  0.031250  0.421317  0.421350  0.421350  0.421350  0.421350  0.421350</span>

<span class="sd">    The final result is 0.421350396475 after 33 function evaluations.</span>

<span class="sd">    &gt;&gt;&gt; print(&quot;%g %g&quot; % (2*result, erf(1)))</span>
<span class="sd">    0.842701 0.842701</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Romberg integration only available &quot;</span>
                         <span class="s2">&quot;for finite limits.&quot;</span><span class="p">)</span>
    <span class="n">vfunc</span> <span class="o">=</span> <span class="n">vectorize1</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">vec_func</span><span class="o">=</span><span class="n">vec_func</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
    <span class="n">intrange</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">ordsum</span> <span class="o">=</span> <span class="n">_difftrap</span><span class="p">(</span><span class="n">vfunc</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">intrange</span> <span class="o">*</span> <span class="n">ordsum</span>
    <span class="n">resmat</span> <span class="o">=</span> <span class="p">[[</span><span class="n">result</span><span class="p">]]</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">last_row</span> <span class="o">=</span> <span class="n">resmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">divmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">ordsum</span> <span class="o">+=</span> <span class="n">_difftrap</span><span class="p">(</span><span class="n">vfunc</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">intrange</span> <span class="o">*</span> <span class="n">ordsum</span> <span class="o">/</span> <span class="n">n</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_romberg_diff</span><span class="p">(</span><span class="n">last_row</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">lastresult</span> <span class="o">=</span> <span class="n">last_row</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">resmat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result</span> <span class="o">-</span> <span class="n">lastresult</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">rtol</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="n">last_row</span> <span class="o">=</span> <span class="n">row</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;divmax (</span><span class="si">%d</span><span class="s2">) exceeded. Latest difference = </span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">divmax</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
            <span class="n">AccuracyWarning</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">_printresmat</span><span class="p">(</span><span class="n">vfunc</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">resmat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># Coefficients for Newton-Cotes quadrature</span>
<span class="c1">#</span>
<span class="c1"># These are the points being used</span>
<span class="c1">#  to construct the local interpolating polynomial</span>
<span class="c1">#  a are the weights for Newton-Cotes integration</span>
<span class="c1">#  B is the error coefficient.</span>
<span class="c1">#  error in these coefficients grows as N gets larger.</span>
<span class="c1">#  or as samples are closer and closer together</span>

<span class="c1"># You can use maxima to find these rational coefficients</span>
<span class="c1">#  for equally spaced data using the commands</span>
<span class="c1">#  a(i,N) := integrate(product(r-j,j,0,i-1) * product(r-j,j,i+1,N),r,0,N) / ((N-i)! * i!) * (-1)^(N-i);</span>
<span class="c1">#  Be(N) := N^(N+2)/(N+2)! * (N/(N+3) - sum((i/N)^(N+2)*a(i,N),i,0,N));</span>
<span class="c1">#  Bo(N) := N^(N+1)/(N+1)! * (N/(N+2) - sum((i/N)^(N+1)*a(i,N),i,0,N));</span>
<span class="c1">#  B(N) := (if (mod(N,2)=0) then Be(N) else Bo(N));</span>
<span class="c1">#</span>
<span class="c1"># pre-computed for equally-spaced weights</span>
<span class="c1">#</span>
<span class="c1"># num_a, den_a, int_a, num_B, den_B = _builtincoeffs[N]</span>
<span class="c1">#</span>
<span class="c1">#  a = num_a*array(int_a)/den_a</span>
<span class="c1">#  B = num_B*1.0 / den_B</span>
<span class="c1">#</span>
<span class="c1">#  integrate(f(x),x,x_0,x_N) = dx*sum(a*f(x_i)) + B*(dx)^(2k+3) f^(2k+2)(x*)</span>
<span class="c1">#    where k = N // 2</span>
<span class="c1">#</span>
<span class="n">_builtincoeffs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">80</span><span class="p">),</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">45</span><span class="p">,[</span><span class="mi">7</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">945</span><span class="p">),</span>
    <span class="mi">5</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">288</span><span class="p">,[</span><span class="mi">19</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">19</span><span class="p">],</span><span class="o">-</span><span class="mi">275</span><span class="p">,</span><span class="mi">12096</span><span class="p">),</span>
    <span class="mi">6</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">140</span><span class="p">,[</span><span class="mi">41</span><span class="p">,</span><span class="mi">216</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">272</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">216</span><span class="p">,</span><span class="mi">41</span><span class="p">],</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="mi">1400</span><span class="p">),</span>
    <span class="mi">7</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">17280</span><span class="p">,[</span><span class="mi">751</span><span class="p">,</span><span class="mi">3577</span><span class="p">,</span><span class="mi">1323</span><span class="p">,</span><span class="mi">2989</span><span class="p">,</span><span class="mi">2989</span><span class="p">,</span><span class="mi">1323</span><span class="p">,</span><span class="mi">3577</span><span class="p">,</span><span class="mi">751</span><span class="p">],</span><span class="o">-</span><span class="mi">8183</span><span class="p">,</span><span class="mi">518400</span><span class="p">),</span>
    <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">14175</span><span class="p">,[</span><span class="mi">989</span><span class="p">,</span><span class="mi">5888</span><span class="p">,</span><span class="o">-</span><span class="mi">928</span><span class="p">,</span><span class="mi">10496</span><span class="p">,</span><span class="o">-</span><span class="mi">4540</span><span class="p">,</span><span class="mi">10496</span><span class="p">,</span><span class="o">-</span><span class="mi">928</span><span class="p">,</span><span class="mi">5888</span><span class="p">,</span><span class="mi">989</span><span class="p">],</span>
        <span class="o">-</span><span class="mi">2368</span><span class="p">,</span><span class="mi">467775</span><span class="p">),</span>
    <span class="mi">9</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">89600</span><span class="p">,[</span><span class="mi">2857</span><span class="p">,</span><span class="mi">15741</span><span class="p">,</span><span class="mi">1080</span><span class="p">,</span><span class="mi">19344</span><span class="p">,</span><span class="mi">5778</span><span class="p">,</span><span class="mi">5778</span><span class="p">,</span><span class="mi">19344</span><span class="p">,</span><span class="mi">1080</span><span class="p">,</span>
                 <span class="mi">15741</span><span class="p">,</span><span class="mi">2857</span><span class="p">],</span> <span class="o">-</span><span class="mi">4671</span><span class="p">,</span> <span class="mi">394240</span><span class="p">),</span>
    <span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">299376</span><span class="p">,[</span><span class="mi">16067</span><span class="p">,</span><span class="mi">106300</span><span class="p">,</span><span class="o">-</span><span class="mi">48525</span><span class="p">,</span><span class="mi">272400</span><span class="p">,</span><span class="o">-</span><span class="mi">260550</span><span class="p">,</span><span class="mi">427368</span><span class="p">,</span>
                   <span class="o">-</span><span class="mi">260550</span><span class="p">,</span><span class="mi">272400</span><span class="p">,</span><span class="o">-</span><span class="mi">48525</span><span class="p">,</span><span class="mi">106300</span><span class="p">,</span><span class="mi">16067</span><span class="p">],</span>
         <span class="o">-</span><span class="mi">673175</span><span class="p">,</span> <span class="mi">163459296</span><span class="p">),</span>
    <span class="mi">11</span><span class="p">:</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">87091200</span><span class="p">,[</span><span class="mi">2171465</span><span class="p">,</span><span class="mi">13486539</span><span class="p">,</span><span class="o">-</span><span class="mi">3237113</span><span class="p">,</span> <span class="mi">25226685</span><span class="p">,</span><span class="o">-</span><span class="mi">9595542</span><span class="p">,</span>
                      <span class="mi">15493566</span><span class="p">,</span><span class="mi">15493566</span><span class="p">,</span><span class="o">-</span><span class="mi">9595542</span><span class="p">,</span><span class="mi">25226685</span><span class="p">,</span><span class="o">-</span><span class="mi">3237113</span><span class="p">,</span>
                      <span class="mi">13486539</span><span class="p">,</span><span class="mi">2171465</span><span class="p">],</span> <span class="o">-</span><span class="mi">2224234463</span><span class="p">,</span> <span class="mi">237758976000</span><span class="p">),</span>
    <span class="mi">12</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5255250</span><span class="p">,</span> <span class="p">[</span><span class="mi">1364651</span><span class="p">,</span><span class="mi">9903168</span><span class="p">,</span><span class="o">-</span><span class="mi">7587864</span><span class="p">,</span><span class="mi">35725120</span><span class="p">,</span><span class="o">-</span><span class="mi">51491295</span><span class="p">,</span>
                      <span class="mi">87516288</span><span class="p">,</span><span class="o">-</span><span class="mi">87797136</span><span class="p">,</span><span class="mi">87516288</span><span class="p">,</span><span class="o">-</span><span class="mi">51491295</span><span class="p">,</span><span class="mi">35725120</span><span class="p">,</span>
                      <span class="o">-</span><span class="mi">7587864</span><span class="p">,</span><span class="mi">9903168</span><span class="p">,</span><span class="mi">1364651</span><span class="p">],</span> <span class="o">-</span><span class="mi">3012</span><span class="p">,</span> <span class="mi">875875</span><span class="p">),</span>
    <span class="mi">13</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">402361344000</span><span class="p">,[</span><span class="mi">8181904909</span><span class="p">,</span> <span class="mi">56280729661</span><span class="p">,</span> <span class="o">-</span><span class="mi">31268252574</span><span class="p">,</span>
                           <span class="mi">156074417954</span><span class="p">,</span><span class="o">-</span><span class="mi">151659573325</span><span class="p">,</span><span class="mi">206683437987</span><span class="p">,</span>
                           <span class="o">-</span><span class="mi">43111992612</span><span class="p">,</span><span class="o">-</span><span class="mi">43111992612</span><span class="p">,</span><span class="mi">206683437987</span><span class="p">,</span>
                           <span class="o">-</span><span class="mi">151659573325</span><span class="p">,</span><span class="mi">156074417954</span><span class="p">,</span><span class="o">-</span><span class="mi">31268252574</span><span class="p">,</span>
                           <span class="mi">56280729661</span><span class="p">,</span><span class="mi">8181904909</span><span class="p">],</span> <span class="o">-</span><span class="mi">2639651053</span><span class="p">,</span>
         <span class="mi">344881152000</span><span class="p">),</span>
    <span class="mi">14</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2501928000</span><span class="p">,</span> <span class="p">[</span><span class="mi">90241897</span><span class="p">,</span><span class="mi">710986864</span><span class="p">,</span><span class="o">-</span><span class="mi">770720657</span><span class="p">,</span><span class="mi">3501442784</span><span class="p">,</span>
                         <span class="o">-</span><span class="mi">6625093363</span><span class="p">,</span><span class="mi">12630121616</span><span class="p">,</span><span class="o">-</span><span class="mi">16802270373</span><span class="p">,</span><span class="mi">19534438464</span><span class="p">,</span>
                         <span class="o">-</span><span class="mi">16802270373</span><span class="p">,</span><span class="mi">12630121616</span><span class="p">,</span><span class="o">-</span><span class="mi">6625093363</span><span class="p">,</span><span class="mi">3501442784</span><span class="p">,</span>
                         <span class="o">-</span><span class="mi">770720657</span><span class="p">,</span><span class="mi">710986864</span><span class="p">,</span><span class="mi">90241897</span><span class="p">],</span> <span class="o">-</span><span class="mi">3740727473</span><span class="p">,</span>
         <span class="mi">1275983280000</span><span class="p">)</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">newton_cotes</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return weights and error coefficient for Newton-Cotes integration.</span>

<span class="sd">    Suppose we have (N+1) samples of f at the positions</span>
<span class="sd">    x_0, x_1, ..., x_N. Then an N-point Newton-Cotes formula for the</span>
<span class="sd">    integral between x_0 and x_N is:</span>

<span class="sd">    :math:`\int_{x_0}^{x_N} f(x)dx = \Delta x \sum_{i=0}^{N} a_i f(x_i)</span>
<span class="sd">    + B_N (\Delta x)^{N+2} f^{N+1} (\xi)`</span>

<span class="sd">    where :math:`\xi \in [x_0,x_N]`</span>
<span class="sd">    and :math:`\Delta x = \frac{x_N-x_0}{N}` is the average samples spacing.</span>

<span class="sd">    If the samples are equally-spaced and N is even, then the error</span>
<span class="sd">    term is :math:`B_N (\Delta x)^{N+3} f^{N+2}(\xi)`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rn : int</span>
<span class="sd">        The integer order for equally-spaced data or the relative positions of</span>
<span class="sd">        the samples with the first sample at 0 and the last at N, where N+1 is</span>
<span class="sd">        the length of `rn`. N is the order of the Newton-Cotes integration.</span>
<span class="sd">    equal : int, optional</span>
<span class="sd">        Set to 1 to enforce equally spaced data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    an : ndarray</span>
<span class="sd">        1-D array of weights to apply to the function at the provided sample</span>
<span class="sd">        positions.</span>
<span class="sd">    B : float</span>
<span class="sd">        Error coefficient.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Normally, the Newton-Cotes rules are used on smaller integration</span>
<span class="sd">    regions and a composite rule is used to return the total integral.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Compute the integral of sin(x) in [0, :math:`\pi`]:</span>

<span class="sd">    &gt;&gt;&gt; from scipy.integrate import newton_cotes</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; def f(x):</span>
<span class="sd">    ...     return np.sin(x)</span>
<span class="sd">    &gt;&gt;&gt; a = 0</span>
<span class="sd">    &gt;&gt;&gt; b = np.pi</span>
<span class="sd">    &gt;&gt;&gt; exact = 2</span>
<span class="sd">    &gt;&gt;&gt; for N in [2, 4, 6, 8, 10]:</span>
<span class="sd">    ...     x = np.linspace(a, b, N + 1)</span>
<span class="sd">    ...     an, B = newton_cotes(N, 1)</span>
<span class="sd">    ...     dx = (b - a) / N</span>
<span class="sd">    ...     quad = dx * np.sum(an * f(x))</span>
<span class="sd">    ...     error = abs(quad - exact)</span>
<span class="sd">    ...     print(&#39;{:2d}  {:10.9f}  {:.5e}&#39;.format(N, quad, error))</span>
<span class="sd">    ...</span>
<span class="sd">     2   2.094395102   9.43951e-02</span>
<span class="sd">     4   1.998570732   1.42927e-03</span>
<span class="sd">     6   2.000017814   1.78136e-05</span>
<span class="sd">     8   1.999999835   1.64725e-07</span>
<span class="sd">    10   2.000000001   1.14677e-09</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">equal</span><span class="p">:</span>
            <span class="n">rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">rn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">equal</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">rn</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">equal</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">equal</span> <span class="ow">and</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">_builtincoeffs</span><span class="p">:</span>
        <span class="n">na</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">vi</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="n">_builtincoeffs</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>
        <span class="n">an</span> <span class="o">=</span> <span class="n">na</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">da</span>
        <span class="k">return</span> <span class="n">an</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span><span class="o">/</span><span class="n">db</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The sample positions must start at 0&quot;</span>
                         <span class="s2">&quot; and end at N&quot;</span><span class="p">)</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">rn</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">yi</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">ti</span> <span class="o">**</span> <span class="n">nvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">Cinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="c1"># improve precision of result</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">Cinv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Cinv</span> <span class="o">-</span> <span class="n">Cinv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Cinv</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">nvec</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ai</span> <span class="o">=</span> <span class="n">Cinv</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">equal</span><span class="p">:</span>
        <span class="n">BN</span> <span class="o">=</span> <span class="n">N</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">N</span><span class="o">+</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BN</span> <span class="o">=</span> <span class="n">N</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">BN</span> <span class="o">=</span> <span class="n">BN</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">yi</span><span class="o">**</span><span class="n">power</span><span class="p">,</span> <span class="n">ai</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">power</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">power</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">fac</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ai</span><span class="p">,</span> <span class="n">BN</span><span class="o">*</span><span class="n">fac</span>


<span class="k">def</span> <span class="nf">_qmc_quad_iv</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">n_estimates</span><span class="p">,</span> <span class="n">qrng</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>

    <span class="c1"># lazy import to avoid issues with partially-initialized submodule</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qmc_quad</span><span class="p">,</span> <span class="s1">&#39;qmc&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
        <span class="n">qmc_quad</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">qmc_quad</span><span class="o">.</span><span class="n">stats</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;`func` must be callable.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># a, b will be modified, so copy. Oh well if it&#39;s copied twice.</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">func</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;`func` must evaluate the integrand at points within &quot;</span>
                   <span class="s2">&quot;the integration range; e.g. `func( (a + b) / 2)` &quot;</span>
                   <span class="s2">&quot;must return the integrand at the centroid of the &quot;</span>
                   <span class="s2">&quot;integration volume.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Exception encountered when attempting vectorized call to &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;`func`: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. For better performance, `func` should &quot;</span>
                   <span class="s2">&quot;accept two-dimensional array `x` with shape `(len(a), &quot;</span>
                   <span class="s2">&quot;n_points)` and return an array of the integrand value at &quot;</span>
                   <span class="s2">&quot;each of the `n_points.&quot;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">vfunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

    <span class="n">n_points_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_points</span> <span class="o">!=</span> <span class="n">n_points_int</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;`n_points` must be an integer.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">n_estimates_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">n_estimates</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_estimates</span> <span class="o">!=</span> <span class="n">n_estimates_int</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;`n_estimates` must be an integer.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">qrng</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qrng</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">qmc</span><span class="o">.</span><span class="n">Halton</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qrng</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">qmc</span><span class="o">.</span><span class="n">QMCEngine</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;`qrng` must be an instance of scipy.stats.qmc.QMCEngine.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">qrng</span><span class="o">.</span><span class="n">d</span> <span class="o">!=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;`qrng` must be initialized with dimensionality equal to &quot;</span>
                   <span class="s2">&quot;the number of variables in `a`, i.e., &quot;</span>
                   <span class="s2">&quot;`qrng.random().shape[-1]` must equal `a.shape[0]`.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">rng_seed</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qrng</span><span class="p">,</span> <span class="s1">&#39;rng_seed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">_qmc</span><span class="o">.</span><span class="n">check_random_state</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">}:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;`log` must be boolean (`True` or `False`).&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vfunc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_points_int</span><span class="p">,</span> <span class="n">n_estimates_int</span><span class="p">,</span> <span class="n">qrng</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>


<span class="n">QMCQuadResult</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;QMCQuadResult&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;integral&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_error&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">qmc_quad</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">n_estimates</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">qrng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute an integral in N-dimensions using Quasi-Monte Carlo quadrature.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : callable</span>
<span class="sd">        The integrand. Must accept a single argument ``x``, an array which</span>
<span class="sd">        specifies the point(s) at which to evaluate the scalar-valued</span>
<span class="sd">        integrand, and return the value(s) of the integrand.</span>
<span class="sd">        For efficiency, the function should be vectorized to accept an array of</span>
<span class="sd">        shape ``(d, n_points)``, where ``d`` is the number of variables (i.e.</span>
<span class="sd">        the dimensionality of the function domain) and `n_points` is the number</span>
<span class="sd">        of quadrature points, and return an array of shape ``(n_points,)``,</span>
<span class="sd">        the integrand at each quadrature point.</span>
<span class="sd">    a, b : array-like</span>
<span class="sd">        One-dimensional arrays specifying the lower and upper integration</span>
<span class="sd">        limits, respectively, of each of the ``d`` variables.</span>
<span class="sd">    n_estimates, n_points : int, optional</span>
<span class="sd">        `n_estimates` (default: 8) statistically independent QMC samples, each</span>
<span class="sd">        of `n_points` (default: 1024) points, will be generated by `qrng`.</span>
<span class="sd">        The total number of points at which the integrand `func` will be</span>
<span class="sd">        evaluated is ``n_points * n_estimates``. See Notes for details.</span>
<span class="sd">    qrng : `~scipy.stats.qmc.QMCEngine`, optional</span>
<span class="sd">        An instance of the QMCEngine from which to sample QMC points.</span>
<span class="sd">        The QMCEngine must be initialized to a number of dimensions ``d``</span>
<span class="sd">        corresponding with the number of variables ``x1, ..., xd`` passed to</span>
<span class="sd">        `func`.</span>
<span class="sd">        The provided QMCEngine is used to produce the first integral estimate.</span>
<span class="sd">        If `n_estimates` is greater than one, additional QMCEngines are</span>
<span class="sd">        spawned from the first (with scrambling enabled, if it is an option.)</span>
<span class="sd">        If a QMCEngine is not provided, the default `scipy.stats.qmc.Halton`</span>
<span class="sd">        will be initialized with the number of dimensions determine from</span>
<span class="sd">        the length of `a`.</span>
<span class="sd">    log : boolean, default: False</span>
<span class="sd">        When set to True, `func` returns the log of the integrand, and</span>
<span class="sd">        the result object contains the log of the integral.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : object</span>
<span class="sd">        A result object with attributes:</span>

<span class="sd">        integral : float</span>
<span class="sd">            The estimate of the integral.</span>
<span class="sd">        standard_error :</span>
<span class="sd">            The error estimate. See Notes for interpretation.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Values of the integrand at each of the `n_points` points of a QMC sample</span>
<span class="sd">    are used to produce an estimate of the integral. This estimate is drawn</span>
<span class="sd">    from a population of possible estimates of the integral, the value of</span>
<span class="sd">    which we obtain depends on the particular points at which the integral</span>
<span class="sd">    was evaluated. We perform this process `n_estimates` times, each time</span>
<span class="sd">    evaluating the integrand at different scrambled QMC points, effectively</span>
<span class="sd">    drawing i.i.d. random samples from the population of integral estimates.</span>
<span class="sd">    The sample mean :math:`m` of these integral estimates is an</span>
<span class="sd">    unbiased estimator of the true value of the integral, and the standard</span>
<span class="sd">    error of the mean :math:`s` of these estimates may be used to generate</span>
<span class="sd">    confidence intervals using the t distribution with ``n_estimates - 1``</span>
<span class="sd">    degrees of freedom. Perhaps counter-intuitively, increasing `n_points`</span>
<span class="sd">    while keeping the total number of function evaluation points</span>
<span class="sd">    ``n_points * n_estimates`` fixed tends to reduce the actual error, whereas</span>
<span class="sd">    increasing `n_estimates` tends to decrease the error estimate.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    QMC quadrature is particularly useful for computing integrals in higher</span>
<span class="sd">    dimensions. An example integrand is the probability density function</span>
<span class="sd">    of a multivariate normal distribution.</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from scipy import stats</span>
<span class="sd">    &gt;&gt;&gt; dim = 8</span>
<span class="sd">    &gt;&gt;&gt; mean = np.zeros(dim)</span>
<span class="sd">    &gt;&gt;&gt; cov = np.eye(dim)</span>
<span class="sd">    &gt;&gt;&gt; def func(x):</span>
<span class="sd">    ...     # `multivariate_normal` expects the _last_ axis to correspond with</span>
<span class="sd">    ...     # the dimensionality of the space, so `x` must be transposed</span>
<span class="sd">    ...     return stats.multivariate_normal.pdf(x.T, mean, cov)</span>

<span class="sd">    To compute the integral over the unit hypercube:</span>

<span class="sd">    &gt;&gt;&gt; from scipy.integrate import qmc_quad</span>
<span class="sd">    &gt;&gt;&gt; a = np.zeros(dim)</span>
<span class="sd">    &gt;&gt;&gt; b = np.ones(dim)</span>
<span class="sd">    &gt;&gt;&gt; rng = np.random.default_rng()</span>
<span class="sd">    &gt;&gt;&gt; qrng = stats.qmc.Halton(d=dim, seed=rng)</span>
<span class="sd">    &gt;&gt;&gt; n_estimates = 8</span>
<span class="sd">    &gt;&gt;&gt; res = qmc_quad(func, a, b, n_estimates=n_estimates, qrng=qrng)</span>
<span class="sd">    &gt;&gt;&gt; res.integral, res.standard_error</span>
<span class="sd">    (0.00018429555666024108, 1.0389431116001344e-07)</span>

<span class="sd">    A two-sided, 99% confidence interval for the integral may be estimated</span>
<span class="sd">    as:</span>

<span class="sd">    &gt;&gt;&gt; t = stats.t(df=n_estimates-1, loc=res.integral,</span>
<span class="sd">    ...             scale=res.standard_error)</span>
<span class="sd">    &gt;&gt;&gt; t.interval(0.99)</span>
<span class="sd">    (0.0001839319802536469, 0.00018465913306683527)</span>

<span class="sd">    Indeed, the value reported by `scipy.stats.multivariate_normal` is</span>
<span class="sd">    within this range.</span>

<span class="sd">    &gt;&gt;&gt; stats.multivariate_normal.cdf(b, mean, cov, lower_limit=a)</span>
<span class="sd">    0.00018430867675187443</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">_qmc_quad_iv</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">n_estimates</span><span class="p">,</span> <span class="n">qrng</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
    <span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">n_estimates</span><span class="p">,</span> <span class="n">qrng</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">sum_product</span><span class="p">(</span><span class="n">integrands</span><span class="p">,</span> <span class="n">dA</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">integrands</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dA</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">integrands</span> <span class="o">*</span> <span class="n">dA</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_estimates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">estimates</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">estimates</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">))</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">logsumexp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
                                  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_estimates</span> <span class="o">-</span> <span class="n">ddof</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="n">ddof</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sem</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">std</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_estimates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_estimates</span><span class="p">)</span>

    <span class="c1"># The sign of the integral depends on the order of the limits. Fix this by</span>
    <span class="c1"># ensuring that lower bounds are indeed lower and setting sign of resulting</span>
    <span class="c1"># integral manually</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A lower limit was equal to an upper limit, so the value &quot;</span>
                   <span class="s2">&quot;of the integral is zero by definition.&quot;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QMCQuadResult</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">log</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">i_swap</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">i_swap</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># odd # of swaps -&gt; negative</span>
    <span class="n">a</span><span class="p">[</span><span class="n">i_swap</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i_swap</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i_swap</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">i_swap</span><span class="p">]</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">dA</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">n_points</span>

    <span class="n">estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_estimates</span><span class="p">)</span>
    <span class="n">rngs</span> <span class="o">=</span> <span class="n">_rng_spawn</span><span class="p">(</span><span class="n">qrng</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">n_estimates</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_estimates</span><span class="p">):</span>
        <span class="c1"># Generate integral estimate</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">qrng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
        <span class="c1"># The rationale for transposing is that this allows users to easily</span>
        <span class="c1"># unpack `x` into separate variables, if desired. This is consistent</span>
        <span class="c1"># with the `xx` array passed into the `scipy.integrate.nquad` `func`.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">qmc</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># (n_dim, n_points)</span>
        <span class="n">integrands</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">estimates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_product</span><span class="p">(</span><span class="n">integrands</span><span class="p">,</span> <span class="n">dA</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

        <span class="c1"># Get a new, independently-scrambled QRNG for next time</span>
        <span class="n">qrng</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">qrng</span><span class="p">)(</span><span class="n">seed</span><span class="o">=</span><span class="n">rngs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">qrng</span><span class="o">.</span><span class="n">_init_quad</span><span class="p">)</span>

    <span class="n">integral</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
    <span class="n">standard_error</span> <span class="o">=</span> <span class="n">sem</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">integral</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    <span class="n">integral</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span> <span class="k">if</span> <span class="p">(</span><span class="n">log</span> <span class="ow">and</span> <span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">integral</span><span class="o">*</span><span class="n">sign</span>
    <span class="k">return</span> <span class="n">QMCQuadResult</span><span class="p">(</span><span class="n">integral</span><span class="p">,</span> <span class="n">standard_error</span><span class="p">)</span>
</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, Cyril Gadal.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>